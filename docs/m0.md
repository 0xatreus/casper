# M0 Foundation

## Goal

Lock the data model and plugin contract so everything else builds on stable primitives.
Wire storage, core APIs, and introduce migrations.

## What M0 Must Deliver

Schema:
- Canonical Finding and Evidence structures.
- Fetch storage for request/response bodies.
- Exceptions and audit trails.

Contract:
- Stable plugin interface and module context.
- Capability gating for safety.

Persistence:
- Alembic migration scaffold.
- Initial migration for all tables and enums.

API coverage:
- Findings, evidence, audit, exceptions.

## Implemented in M0 (this repo)

### Data Model
Tables and key fields:
- Target: base_url, environment, auth_profiles
- Scan: mode, profile_name, profile_capabilities, status, baseline_scan_id, timestamps
- Endpoint: method, url, params_hash, source, first_seen, last_seen
- Fetch: request, response_meta, storage_mode, body_path, body_hash, redaction_version
- Evidence: kind, snippet, location, hash, details (JSON)
- Finding: dedupe_key, type, title, description, severity, confidence, status, remediation,
  references (JSON), cwe_id, cve_id, evidence_ids, source_module, timestamps
- TechComponent: name, version, cpe, confidence, evidence_ids
- CVECandidate: cpe, cve_id, source, confidence, status, linked_component_id
- ExceptionRecord: finding_key, expires_at, approver, ticket, status, reason, owner
- AuditEvent: actor, action, scan_id, params (JSON), immutable

Enums:
- StorageMode: none, sampled, full
- FindingStatus: open, fixed, soft_deleted
- Confidence: low, medium, high
- AuditAction: scan.started, scan.completed, module.run, export.generated,
  exception.created, exception.expired, recheck.triggered

### Event Contract
Modules emit:
- EndpointDiscovered
- FetchEvent (body + metadata)
- EvidenceEvent (details JSON)
- FindingEvent (title, remediation, references, cwe_id, cve_id)
- TechComponentEvent
- CVECandidateEvent
- RecordPack

### Plugin Contract
Plugins implement:
- name, description, version, required_capabilities
- run(scan, context) -> AsyncIterator[Event]

Context provides:
- settings
- DB session factory
- storage backend + default storage mode

### Storage
Local storage backend:
- Redacts and samples response bodies.
- Stores to `object_store_base` path/URI.

### Orchestration
Behavior:
- Create Scan record, audit scan.started.
- Run module tasks with capability gating.
- Persist events and audit module.run.
- Audit scan.completed on success.

### API
Endpoints:
- /targets (GET/POST)
- /scans (GET/POST)
- /findings (GET)
- /evidence (GET)
- /audit (GET)
- /exceptions (GET/POST)

## Migration Strategy (M0)

Alembic is the source of truth for schema evolution.
Initial migration creates all tables and enums.

Commands:
- `./.venv/bin/alembic -c alembic.ini upgrade head`
- `./.venv/bin/alembic -c alembic.ini stamp head` (if schema already exists)

## Definition of Done

- End-to-end scan persists Targets, Scans, Findings, Evidence, Audit.
- Schema is versioned and migratable.
- Plugins can be loaded with a stable interface and capability gating.
